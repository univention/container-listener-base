From f3b257f83171b23d17741f81c22b0d74863c9f91 Mon Sep 17 00:00:00 2001
From: Johannes Bornhold <johannes.bornhold.extern@univention.de>
Date: Thu, 2 May 2024 12:56:34 +0200
Subject: [PATCH 2/2] allow disabling tls

---
 management/univention-directory-listener/src/main.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/management/univention-directory-listener/src/main.c b/management/univention-directory-listener/src/main.c
index 1bd9c94e2d..3ab7221f1c 100644
--- a/management/univention-directory-listener/src/main.c
+++ b/management/univention-directory-listener/src/main.c
@@ -228,6 +228,7 @@ static void usage(void) {
 	fprintf(stderr, "   -y   read LDAP bind password from file\n");
 	fprintf(stderr, "   -x   LDAP simple bind\n");
 	fprintf(stderr, "   -Z   LDAP start TLS request (-ZZ to require successful response)\n");
+	fprintf(stderr, "   -z   LDAP optional TLS (-zz to disable TLS entirely)\n");
 	fprintf(stderr, "   -Y   SASL mechanism\n");
 	fprintf(stderr, "   -U   SASL username\n");
 	fprintf(stderr, "   -R   SASL realm\n");
@@ -414,7 +415,7 @@ int main(int argc, char *argv[]) {
 	for (;;) {
 		int c;
 
-		c = getopt(argc, argv, "d:FH:h:n:p:b:D:w:y:xZY:U:R:Km:Bc:giol:P");
+		c = getopt(argc, argv, "d:FH:h:n:p:b:D:w:y:xZzY:U:R:Km:Bc:giol:P");
 		if (c < 0)
 			break;
 		switch (c) {
@@ -466,6 +467,9 @@ int main(int argc, char *argv[]) {
 		case 'Z':
 			lp->start_tls++;
 			break;
+		case 'z':
+			lp->start_tls--;
+			break;
 		case 'x':
 			lp->authmethod = LDAP_AUTH_SIMPLE;
 			break;
-- 
2.44.0


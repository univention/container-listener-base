---

stages:
- lint-stage
- build-stage
- test-stage
- publish-stage

variables:
  UNIV_DOCKERHUB_MIRROR: artifacts.knut.univention.de
  UNIV_DOCKERHUB_CACHE:
    ${UNIV_DOCKERHUB_MIRROR}/dockerhub_proxy_cache/
  UPX_IMAGE_REGISTRY:
    ${UNIV_DOCKERHUB_MIRROR}/upx/
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375

  CI_PIPELINE_TAG: "${CI_PIPELINE_ID}-"

  DOCKER_COMPOSE_PRODUCTION_FILES:
    --file docker-compose.yaml
    --file docker-compose.prod.yaml

  DOCKER_COMPOSE_BUILD_FILES:
    ${DOCKER_COMPOSE_PRODUCTION_FILES}
    --file docker-compose.override.yaml

default:
  before_script:
  - mkdir "$HOME/.docker/"
  - echo "$DOCKER_AUTH_CONFIG" > "$HOME/.docker/config.json"

pre-commit-job:
  stage: lint-stage
  image: ${UPX_IMAGE_REGISTRY}container-pre-commit/pre-commit:latest
  variables:
    PIP_CACHE_DIR: ${CI_PROJECT_DIR}/.cache/pip
    PRE_COMMIT_HOME: ${CI_PROJECT_DIR}/.cache/pre-commit
  cache:
    paths:
    - .cache/pip
    - .cache/pre-commit
    - venv/
  script:
  # Compose lint would fail without the referenced env files
  - cp .env.listener.example .env.listener
  - pre-commit run --all-files

build-job:
  # Only the debian flavor seems to be working with dind out of the box
  # the alpine as of 1.28.0 does not because of a mismatch issue
  # between "musl libc" vs glibc:
  # https://github.com/docker/compose/issues/3465
  # https://stackoverflow.com/a/42322893
  image: ${UNIV_DOCKERHUB_CACHE}docker/compose:debian-1.28.0
  stage: build-stage
  tags:
    - docker
  services:
    - name: ${UNIV_DOCKERHUB_CACHE}library/docker:18.09.7-dind
      alias: docker
      command: ["--insecure-registry=artifacts.knut.univention.de"]
  script:
    - cp .env.listener.example .env.listener
    - docker-compose ${DOCKER_COMPOSE_BUILD_FILES} build
    - docker-compose ${DOCKER_COMPOSE_BUILD_FILES} push

test-job:
  image: ${UNIV_DOCKERHUB_CACHE}docker/compose:debian-1.28.0
  stage: test-stage
  tags:
    - docker
  services:
    - name: ${UNIV_DOCKERHUB_CACHE}library/docker:18.09.7-dind
      alias: docker
      command: ["--insecure-registry=artifacts.knut.univention.de"]
  script:
    - cp .env.listener.example .env.listener
    - cp "${LDAP_SECRET}" secret/ldap.secret
    - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} pull
    - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} up --detach --no-build
    - echo "TODO test here"
    - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} down
    - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} rm
  artifacts:
    when: always
    expire_in: 4 weeks
    reports:
      junit: integration-test/robot_results/xunit.xml
    paths:
    - integration-test/robot_results

publish-job:
  image: ${UNIV_DOCKERHUB_CACHE}docker/compose:debian-1.28.0
  stage: publish-stage
  tags:
    - docker
  only:
    - main
  services:
    - name: ${UNIV_DOCKERHUB_CACHE}library/docker:18.09.7-dind
      alias: docker
      command: ["--insecure-registry=artifacts.knut.univention.de"]
  script:
    - cp .env.listener.example .env.listener
    - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} pull
    - docker tag
      ${UPX_IMAGE_REGISTRY}container-listener-base/listener:${CI_PIPELINE_TAG}test
      ${UPX_IMAGE_REGISTRY}container-listener-base/listener:latest
    - docker push
      ${UPX_IMAGE_REGISTRY}container-listener-base/listener:latest

...

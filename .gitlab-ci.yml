---

stages:
  - lint
  - build
  - test
  - publish

include:
  - project: univention/dist/docker-services
    file: kaniko.yml
  - project: univention/customers/dataport/upx/common-ci
    file:
      - defaults/souvap-workflow.yaml
      - templates/souvap.yaml
      - jobs/lint-pre-commit.yaml

variables:
  UNIV_DOCKERHUB_MIRROR: artifacts.knut.univention.de
  UNIV_DOCKERHUB_CACHE: ${UNIV_DOCKERHUB_MIRROR}/dockerhub_proxy_cache/
  UPX_IMAGE_REGISTRY: ${UNIV_DOCKERHUB_MIRROR}/upx/
  DOCKER_TLS_CERTDIR: ''
  DOCKER_HOST: tcp://docker:2375

  DOCKER_COMPOSE_PRODUCTION_FILES:
    --file docker-compose.yaml
    --file docker-compose.prod.yaml

  DOCKER_COMPOSE_BUILD_FILES:
    ${DOCKER_COMPOSE_PRODUCTION_FILES}
    --file docker-compose.build.yaml

default:
  before_script:
  - mkdir "$HOME/.docker/"
  - echo "$DOCKER_AUTH_CONFIG" > "$HOME/.docker/config.json"


lint-pre-commit:
  before_script:
    # Compose lint would fail without the referenced env files
    - cp .env.listener.example .env.listener


build-job:
  image:
    ${UPX_IMAGE_REGISTRY}docker/compose:1.30-debian-buster-python-3.7.3
  needs: []
  stage: build
  tags:
  - docker
  services:
  - name: ${UNIV_DOCKERHUB_CACHE}library/docker:20.10.7-dind
    alias: docker
    command:
    - "--insecure-registry=artifacts.knut.univention.de"
    - "--tls=false"
  script:
  - apt-get update
  - apt-get --assume-yes --verbose-versions --no-install-recommends install python3-sh
  - python3 ci-build-script.py

build-with-kaniko:
  stage: build
  extends: .kaniko
  needs: []
  before_script: ""
  variables:
    DOCKERFILE_PATH: "new.Dockerfile"
  #   CI_DEBUG_TRACE: "true"

test-job:
  image:
    ${UPX_IMAGE_REGISTRY}docker/compose:1.30-debian-buster-python-3.7.3
  stage: test
  tags:
  - docker
  services:
  - name: ${UNIV_DOCKERHUB_CACHE}library/docker:20.10.7-dind
    alias: docker
    command:
    - "--insecure-registry=artifacts.knut.univention.de"
    - "--tls=false"
  script:
  - cp .env.listener.example .env.listener
  - cp "${LDAP_SECRET}" secret/ldap.secret
  - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} pull
  - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} up --detach --no-build
  - echo "TODO test here"
  - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} down
  - docker-compose ${DOCKER_COMPOSE_PRODUCTION_FILES} rm
  artifacts:
    when: always
    expire_in: 4 weeks
    reports:
      junit: integration-test/robot_results/xunit.xml
    paths:
    - integration-test/robot_results

publish-job:
  image:
    ${UPX_IMAGE_REGISTRY}docker/compose:1.30-debian-buster-python-3.7.3
  stage: publish
  tags:
  - docker
  only:
  - main
  services:
  - name: ${UNIV_DOCKERHUB_CACHE}library/docker:20.10.7-dind
    alias: docker
    command:
    - "--insecure-registry=artifacts.knut.univention.de"
    - "--tls=false"
  script:
  - apt-get update
  - apt-get --assume-yes --verbose-versions --no-install-recommends install python3-sh
  - python3 ci-publish-script.py
...
